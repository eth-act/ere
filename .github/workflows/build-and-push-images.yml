name: Build and push images

on:
  push:
    branches:
      - master
    tags:
      - 'v*'

jobs:
  build_and_push:
    name: Build and push docker image (${{ matrix.zkvm }})
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - { zkvm: airbender, cuda: true  }
          - { zkvm: jolt,      cuda: false }
          - { zkvm: miden,     cuda: false }
          - { zkvm: nexus,     cuda: false }
          - { zkvm: openvm,    cuda: true  }
          - { zkvm: pico,      cuda: false }
          - { zkvm: risc0,     cuda: true  }
          - { zkvm: sp1,       cuda: true  }
          - { zkvm: ziren,     cuda: false }
          - { zkvm: zisk,      cuda: true  }
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: bash .github/scripts/free-up-disk-space.sh

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image tag and registry
        id: meta
        run: |
          GIT_SHA="${{ github.sha }}"
          echo "tag=${GIT_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "registry=ghcr.io/${{ github.repository }}" >> $GITHUB_OUTPUT

      - name: Build ere-base and ere-base-${{ matrix.zkvm }} images
        run: |
          bash .github/scripts/build-image.sh \
            --zkvm ${{ matrix.zkvm }} \
            --registry ${{ steps.meta.outputs.registry }} \
            --tag ${{ steps.meta.outputs.tag }} \
            --base

      - name: Push ere-base and ere-base-${{ matrix.zkvm }} images
        run: |
          docker push ${{ steps.meta.outputs.registry }}/ere-base:${{ steps.meta.outputs.tag }}
          docker push ${{ steps.meta.outputs.registry }}/ere-base-${{ matrix.zkvm }}:${{ steps.meta.outputs.tag }}

      - name: Build ere-compiler-${{ matrix.zkvm }} and ere-server-${{ matrix.zkvm }} images
        run: |
          bash .github/scripts/build-image.sh \
            --zkvm ${{ matrix.zkvm }} \
            --registry ${{ steps.meta.outputs.registry }} \
            --tag ${{ steps.meta.outputs.tag }} \
            --compiler \
            --server

      - name: Push ere-compiler-${{ matrix.zkvm }} and ere-server-${{ matrix.zkvm }} images
        run: |
          docker push ${{ steps.meta.outputs.registry }}/ere-compiler-${{ matrix.zkvm }}:${{ steps.meta.outputs.tag }}
          docker push ${{ steps.meta.outputs.registry }}/ere-server-${{ matrix.zkvm }}:${{ steps.meta.outputs.tag }}

      - name: Build ere-base and ere-base-${{ matrix.zkvm }} images with CUDA enabled
        if: matrix.cuda
        run: |
          bash .github/scripts/build-image.sh \
            --zkvm ${{ matrix.zkvm }} \
            --registry ${{ steps.meta.outputs.registry }} \
            --tag ${{ steps.meta.outputs.tag }}-cuda \
            --base \
            --cuda-archs '89,120'

      - name: Push ere-base and ere-base-${{ matrix.zkvm }} images with CUDA enabled
        if: matrix.cuda
        run: |
          docker push ${{ steps.meta.outputs.registry }}/ere-base:${{ steps.meta.outputs.tag }}-cuda
          docker push ${{ steps.meta.outputs.registry }}/ere-base-${{ matrix.zkvm }}:${{ steps.meta.outputs.tag }}-cuda

      - name: Build ere-server-${{ matrix.zkvm }} image with CUDA enabled
        if: matrix.cuda
        run: |
          bash .github/scripts/build-image.sh \
            --zkvm ${{ matrix.zkvm }} \
            --registry ${{ steps.meta.outputs.registry }} \
            --tag ${{ steps.meta.outputs.tag }}-cuda \
            --server \
            --cuda-archs '89,120'

      - name: Push ere-server-${{ matrix.zkvm }} image with CUDA enabled
        if: matrix.cuda
        run: |
          docker push ${{ steps.meta.outputs.registry }}/ere-server-${{ matrix.zkvm }}:${{ steps.meta.outputs.tag }}-cuda

  create_semver_tag:
    name: Tag images with SemVer (${{ matrix.zkvm }})
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - { zkvm: airbender, cuda: true  }
          - { zkvm: jolt,      cuda: false }
          - { zkvm: miden,     cuda: false }
          - { zkvm: nexus,     cuda: false }
          - { zkvm: openvm,    cuda: true  }
          - { zkvm: pico,      cuda: false }
          - { zkvm: risc0,     cuda: true  }
          - { zkvm: sp1,       cuda: true  }
          - { zkvm: ziren,     cuda: false }
          - { zkvm: zisk,      cuda: true  }
    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Add SemVer tag to images
        run: |
          GIT_SHA="${{ github.sha }}"
          GIT_SHA_TAG="${GIT_SHA:0:7}"

          GIT_TAG="${{ github.ref_name }}"
          SEMVER_TAG="${GIT_TAG#v}"

          IMAGE_REGISTRY="ghcr.io/${{ github.repository }}"

          for IMAGE in \
            "ere-base" \
            "ere-base-${{ matrix.zkvm }}" \
            "ere-compiler-${{ matrix.zkvm }}" \
            "ere-server-${{ matrix.zkvm }}"
          do
            echo "Tagging $IMAGE_REGISTRY/$IMAGE:$GIT_SHA_TAG as $SEMVER_TAG"
            docker buildx imagetools create \
              "$IMAGE_REGISTRY/$IMAGE:$GIT_SHA_TAG" \
              --tag "$IMAGE_REGISTRY/$IMAGE:$SEMVER_TAG"
          done

      - name: Add SemVer tag to images with CUDA enabled
        if: matrix.cuda
        run: |
          GIT_SHA="${{ github.sha }}"
          GIT_SHA_TAG="${GIT_SHA:0:7}"

          GIT_TAG="${{ github.ref_name }}"
          SEMVER_TAG="${GIT_TAG#v}"

          IMAGE_REGISTRY="ghcr.io/${{ github.repository }}"

          for IMAGE in \
            "ere-base" \
            "ere-base-${{ matrix.zkvm }}" \
            "ere-server-${{ matrix.zkvm }}"
          do
            echo "Tagging $IMAGE_REGISTRY/$IMAGE:${GIT_SHA_TAG}-cuda as ${SEMVER_TAG}-cuda"
            docker buildx imagetools create \
              "$IMAGE_REGISTRY/$IMAGE:${GIT_SHA_TAG}-cuda" \
              --tag "$IMAGE_REGISTRY/$IMAGE:${SEMVER_TAG}-cuda"
          done
